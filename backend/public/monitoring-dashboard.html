<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ProFitAgent - Monitoring Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
        }

        .header h1 {
            color: #2c3e50;
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .header p {
            color: #7f8c8d;
            font-size: 1.1rem;
        }

        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .status-healthy { background-color: #27ae60; }
        .status-warning { background-color: #f39c12; }
        .status-error { background-color: #e74c3c; }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .card {
            background: rgba(255, 255, 255, 0.95);
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            transition: transform 0.3s ease;
        }

        .card:hover {
            transform: translateY(-5px);
        }

        .card h3 {
            color: #2c3e50;
            margin-bottom: 15px;
            font-size: 1.3rem;
            border-bottom: 2px solid #3498db;
            padding-bottom: 8px;
        }

        .metric {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            padding: 8px 0;
        }

        .metric-label {
            color: #7f8c8d;
            font-weight: 500;
        }

        .metric-value {
            font-weight: bold;
            color: #2c3e50;
            font-size: 1.1rem;
        }

        .metric-value.success { color: #27ae60; }
        .metric-value.warning { color: #f39c12; }
        .metric-value.error { color: #e74c3c; }

        .chart-container {
            height: 200px;
            margin-top: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #7f8c8d;
        }

        .alerts-list {
            max-height: 300px;
            overflow-y: auto;
        }

        .alert-item {
            padding: 12px;
            margin-bottom: 8px;
            border-radius: 8px;
            border-left: 4px solid;
        }

        .alert-info {
            background: #e3f2fd;
            border-left-color: #2196f3;
        }

        .alert-warning {
            background: #fff3e0;
            border-left-color: #ff9800;
        }

        .alert-error {
            background: #ffebee;
            border-left-color: #f44336;
        }

        .alert-time {
            font-size: 0.9rem;
            color: #7f8c8d;
            margin-top: 5px;
        }

        .refresh-btn {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.3s ease;
            margin-right: 10px;
        }

        .refresh-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(52, 152, 219, 0.3);
        }

        .auto-refresh {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 10px;
        }

        .loading {
            opacity: 0.6;
            pointer-events: none;
        }

        .error-message {
            background: #ffebee;
            color: #c62828;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid #f44336;
        }

        @media (max-width: 768px) {
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
            
            .header h1 {
                font-size: 2rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üöÄ ProFitAgent Monitoring Dashboard</h1>
            <p>Real-time system monitoring and performance metrics</p>
            <div class="auto-refresh">
                <button class="refresh-btn" onclick="refreshData()">üîÑ Refresh Now</button>
                <label>
                    <input type="checkbox" id="autoRefresh" checked> Auto-refresh (30s)
                </label>
                <span id="lastUpdate"></span>
            </div>
        </div>

        <div id="errorMessage" class="error-message" style="display: none;"></div>

        <div class="dashboard-grid">
            <!-- System Health -->
            <div class="card">
                <h3>üè• System Health</h3>
                <div class="metric">
                    <span class="metric-label">Status</span>
                    <span class="metric-value" id="systemStatus">
                        <span class="status-indicator status-healthy"></span>Loading...
                    </span>
                </div>
                <div class="metric">
                    <span class="metric-label">Uptime</span>
                    <span class="metric-value" id="uptime">-</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Memory Usage</span>
                    <span class="metric-value" id="memoryUsage">-</span>
                </div>
                <div class="metric">
                    <span class="metric-label">CPU Usage</span>
                    <span class="metric-value" id="cpuUsage">-</span>
                </div>
            </div>

            <!-- Payment Metrics -->
            <div class="card">
                <h3>üí∞ Payment Metrics</h3>
                <div class="metric">
                    <span class="metric-label">Total Orders</span>
                    <span class="metric-value" id="totalOrders">-</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Confirmed</span>
                    <span class="metric-value success" id="confirmedOrders">-</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Pending</span>
                    <span class="metric-value warning" id="pendingOrders">-</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Failed</span>
                    <span class="metric-value error" id="failedOrders">-</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Total Volume</span>
                    <span class="metric-value" id="totalVolume">-</span>
                </div>
            </div>

            <!-- Agent Performance -->
            <div class="card">
                <h3>ü§ñ Agent Performance</h3>
                <div class="metric">
                    <span class="metric-label">Active Agents</span>
                    <span class="metric-value" id="activeAgents">-</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Total Assignments</span>
                    <span class="metric-value" id="totalAssignments">-</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Avg Daily Return</span>
                    <span class="metric-value" id="avgDailyReturn">-</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Total Trades</span>
                    <span class="metric-value" id="totalTrades">-</span>
                </div>
            </div>

            <!-- Blockchain Status -->
            <div class="card">
                <h3>‚õìÔ∏è Blockchain Status</h3>
                <div class="metric">
                    <span class="metric-label">Connection</span>
                    <span class="metric-value" id="blockchainConnection">-</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Latest Block</span>
                    <span class="metric-value" id="latestBlock">-</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Gas Price</span>
                    <span class="metric-value" id="gasPrice">-</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Network</span>
                    <span class="metric-value" id="network">BSC Mainnet</span>
                </div>
            </div>

            <!-- Database Metrics -->
            <div class="card">
                <h3>üóÑÔ∏è Database Metrics</h3>
                <div class="metric">
                    <span class="metric-label">Connection Pool</span>
                    <span class="metric-value" id="dbConnections">-</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Avg Query Time</span>
                    <span class="metric-value" id="avgQueryTime">-</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Slow Queries</span>
                    <span class="metric-value" id="slowQueries">-</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Failed Queries</span>
                    <span class="metric-value" id="failedQueries">-</span>
                </div>
            </div>

            <!-- Recent Alerts -->
            <div class="card">
                <h3>üö® Recent Alerts</h3>
                <div class="alerts-list" id="alertsList">
                    <div style="text-align: center; color: #7f8c8d; padding: 20px;">
                        Loading alerts...
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let autoRefreshInterval;
        
        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            refreshData();
            setupAutoRefresh();
        });

        // Setup auto-refresh
        function setupAutoRefresh() {
            const checkbox = document.getElementById('autoRefresh');
            
            function toggleAutoRefresh() {
                if (checkbox.checked) {
                    autoRefreshInterval = setInterval(refreshData, 30000); // 30 seconds
                } else {
                    clearInterval(autoRefreshInterval);
                }
            }
            
            checkbox.addEventListener('change', toggleAutoRefresh);
            toggleAutoRefresh(); // Initial setup
        }

        // Refresh all data
        async function refreshData() {
            const container = document.querySelector('.container');
            container.classList.add('loading');
            
            try {
                await Promise.all([
                    loadHealthStatus(),
                    loadMetrics(),
                    loadAlerts()
                ]);
                
                hideError();
                updateLastRefreshTime();
            } catch (error) {
                showError('Failed to refresh data: ' + error.message);
            } finally {
                container.classList.remove('loading');
            }
        }

        // Load health status
        async function loadHealthStatus() {
            try {
                const response = await fetch('/api/monitoring/health');
                const data = await response.json();
                
                if (data.success) {
                    const health = data.data;
                    updateSystemHealth(health);
                }
            } catch (error) {
                console.error('Failed to load health status:', error);
            }
        }

        // Load metrics
        async function loadMetrics() {
            try {
                const response = await fetch('/api/monitoring/metrics', {
                    headers: {
                        'Authorization': 'Bearer ' + getAuthToken()
                    }
                });
                
                if (response.status === 401) {
                    showError('Authentication required. Please login to view metrics.');
                    return;
                }
                
                const data = await response.json();
                
                if (data.success) {
                    updateMetrics(data.data);
                }
            } catch (error) {
                console.error('Failed to load metrics:', error);
            }
        }

        // Load alerts
        async function loadAlerts() {
            try {
                const response = await fetch('/api/monitoring/alerts?limit=10', {
                    headers: {
                        'Authorization': 'Bearer ' + getAuthToken()
                    }
                });
                
                if (response.status === 401) {
                    return; // Already handled in loadMetrics
                }
                
                const data = await response.json();
                
                if (data.success) {
                    updateAlerts(data.data.alerts);
                }
            } catch (error) {
                console.error('Failed to load alerts:', error);
            }
        }

        // Update system health display
        function updateSystemHealth(health) {
            const statusElement = document.getElementById('systemStatus');
            const uptimeElement = document.getElementById('uptime');
            const memoryElement = document.getElementById('memoryUsage');
            
            // Update status
            const statusClass = health.status === 'healthy' ? 'status-healthy' : 
                               health.status === 'degraded' ? 'status-warning' : 'status-error';
            statusElement.innerHTML = `<span class="status-indicator ${statusClass}"></span>${health.status}`;
            
            // Update uptime
            uptimeElement.textContent = formatUptime(health.uptime);
            
            // Update memory
            if (health.memory) {
                const memoryUsed = (health.memory.heapUsed / 1024 / 1024).toFixed(1);
                const memoryTotal = (health.memory.heapTotal / 1024 / 1024).toFixed(1);
                memoryElement.textContent = `${memoryUsed}MB / ${memoryTotal}MB`;
            }
        }

        // Update metrics display
        function updateMetrics(metrics) {
            // Payment metrics
            if (metrics.payments) {
                document.getElementById('totalOrders').textContent = metrics.payments.totalOrders || 0;
                document.getElementById('confirmedOrders').textContent = metrics.payments.confirmedOrders || 0;
                document.getElementById('pendingOrders').textContent = metrics.payments.pendingOrders || 0;
                document.getElementById('failedOrders').textContent = metrics.payments.failedOrders || 0;
                document.getElementById('totalVolume').textContent = formatCurrency(metrics.payments.totalVolume || 0);
            }
            
            // Agent metrics
            if (metrics.agents) {
                document.getElementById('activeAgents').textContent = metrics.agents.activeCount || 0;
                document.getElementById('totalAssignments').textContent = metrics.agents.totalAssignments || 0;
                document.getElementById('avgDailyReturn').textContent = formatPercentage(metrics.agents.avgDailyReturn || 0);
                document.getElementById('totalTrades').textContent = metrics.agents.totalTrades || 0;
            }
            
            // Blockchain metrics
            if (metrics.blockchain) {
                const connectionStatus = metrics.blockchain.connected ? 'Connected' : 'Disconnected';
                const connectionClass = metrics.blockchain.connected ? 'success' : 'error';
                document.getElementById('blockchainConnection').innerHTML = 
                    `<span class="metric-value ${connectionClass}">${connectionStatus}</span>`;
                document.getElementById('latestBlock').textContent = metrics.blockchain.latestBlock || '-';
                document.getElementById('gasPrice').textContent = metrics.blockchain.gasPrice ? 
                    `${metrics.blockchain.gasPrice} Gwei` : '-';
            }
            
            // Database metrics
            if (metrics.database) {
                document.getElementById('dbConnections').textContent = 
                    `${metrics.database.activeConnections || 0}/${metrics.database.maxConnections || 0}`;
                document.getElementById('avgQueryTime').textContent = 
                    `${(metrics.database.avgQueryTime || 0).toFixed(2)}ms`;
                document.getElementById('slowQueries').textContent = metrics.database.slowQueries || 0;
                document.getElementById('failedQueries').textContent = metrics.database.failedQueries || 0;
            }
        }

        // Update alerts display
        function updateAlerts(alerts) {
            const alertsList = document.getElementById('alertsList');
            
            if (!alerts || alerts.length === 0) {
                alertsList.innerHTML = '<div style="text-align: center; color: #7f8c8d; padding: 20px;">No recent alerts</div>';
                return;
            }
            
            alertsList.innerHTML = alerts.map(alert => {
                const alertClass = alert.severity === 'error' ? 'alert-error' : 
                                  alert.severity === 'warning' ? 'alert-warning' : 'alert-info';
                
                return `
                    <div class="alert-item ${alertClass}">
                        <strong>${alert.type}</strong>: ${alert.message}
                        <div class="alert-time">${formatTime(alert.timestamp)}</div>
                    </div>
                `;
            }).join('');
        }

        // Utility functions
        function formatUptime(seconds) {
            const days = Math.floor(seconds / 86400);
            const hours = Math.floor((seconds % 86400) / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            
            if (days > 0) {
                return `${days}d ${hours}h ${minutes}m`;
            } else if (hours > 0) {
                return `${hours}h ${minutes}m`;
            } else {
                return `${minutes}m`;
            }
        }

        function formatCurrency(amount) {
            return new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'USD',
                minimumFractionDigits: 2
            }).format(amount);
        }

        function formatPercentage(value) {
            return `${(value * 100).toFixed(2)}%`;
        }

        function formatTime(timestamp) {
            return new Date(timestamp).toLocaleString();
        }

        function updateLastRefreshTime() {
            document.getElementById('lastUpdate').textContent = 
                `Last updated: ${new Date().toLocaleTimeString()}`;
        }

        function showError(message) {
            const errorElement = document.getElementById('errorMessage');
            errorElement.textContent = message;
            errorElement.style.display = 'block';
        }

        function hideError() {
            document.getElementById('errorMessage').style.display = 'none';
        }

        function getAuthToken() {
            // In a real implementation, this would get the token from localStorage or cookies
            return localStorage.getItem('authToken') || '';
        }
    </script>
</body>
</html>